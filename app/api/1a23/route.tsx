import { ImageResponse } from "@takumi-rs/image-response/wasm";
import type { FontDetails } from "@takumi-rs/wasm";

export const runtime = "edge";

const width = 1200;
const height = 630;
const logoRatio = 1372 / 585;

const typeColors = {
  "open source": "#44af69",
  gallery: "#009ffd",
  design: "#f3a712",
  lyrics: "#fe4e00",
  translation: "#628395",
  miscellaneous: "#2e86ab",
} as Record<string, string>;

const fonts = [
  {
    name: "Inter",
    data: await fetch(
      `https://rsms.me/inter/font-files/InterVariable.woff2?v=4.1`
    ).then((r) => r.arrayBuffer()),
  },
  {
    name: "Inter",
    style: "italic",
    data: await fetch(
      `https://rsms.me/inter/font-files/InterVariable-Italic.woff2?v=4.1`
    ).then((r) => r.arrayBuffer()),
  },
  {
    name: "Red Hat Display",
    data: await fetch(
      "https://cdn.jsdelivr.net/npm/@typewe/redhatdisplay@1.0.0/fonts/RedHatDisplay-Variable.woff2"
    ).then((r) => r.arrayBuffer()),
  },
  {
    name: "Source Han Sans",
    data: await fetch(
      "https://fast-mirror.isrc.ac.cn/adobe-fonts/source-han-sans/Variable/WOFF2/OTF/SourceHanSans-VF.otf.woff2"
    ).then((r) => r.arrayBuffer()),
  },
] as FontDetails[];

const patternData = encodeURIComponent(
  `<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" fill="none" stroke="#38d1c4" stroke-linejoin="round" xmlns:v="https://vecta.io/nano"><path d="M114 102h75V89h-75zm12.489 12l.011 37.5c0 6.899 2.803 13.147 7.328 17.673A24.92 24.92 0 0 0 176.5 151.5c0-6.899-2.803-13.147-7.328-17.673A24.92 24.92 0 0 0 151.5 126.5h-.01c-6.904 0-12.5-5.597-12.5-12.5h12.51c20.697 0 37.5 16.803 37.5 37.5S172.197 189 151.5 189 114 172.197 114 151.5V114h12.489zM114 63.511l37.5-.011a24.92 24.92 0 0 0 17.673-7.327A24.92 24.92 0 0 0 176.5 38.5a24.92 24.92 0 0 0-7.328-17.673 24.92 24.92 0 0 0-35.344 0A24.92 24.92 0 0 0 126.5 38.5v.011c0 6.903-5.596 12.5-12.5 12.5V38.5C114 17.802 130.803 1 151.5 1S189 17.802 189 38.5 172.197 76 151.5 76H114V63.511zM1 102h75V89H1zm88-26h13V1H89zm0 113h13v-75H89zM63.511 76L63.5 38.5c0-6.899-2.802-13.147-7.328-17.673S45.399 13.5 38.5 13.5s-13.147 2.803-17.672 7.327S13.5 31.601 13.5 38.5s2.803 13.147 7.328 17.673S31.601 63.5 38.5 63.5h.011c6.904 0 12.5 5.597 12.5 12.5H38.5C17.803 76 1 59.197 1 38.5S17.803 1 38.5 1 76 17.802 76 38.5V76H63.511zM76 126.489l-37.5.011c-6.899 0-13.147 2.803-17.672 7.327a24.92 24.92 0 0 0 0 35.345c4.525 4.524 10.774 7.327 17.672 7.327s13.148-2.803 17.672-7.327A24.92 24.92 0 0 0 63.5 151.5v-.011c0-6.903 5.596-12.5 12.5-12.5V151.5c0 20.697-16.803 37.5-37.5 37.5S1 172.197 1 151.5 17.803 114 38.5 114H76v12.489z" stroke-width="3" /></svg>`
);
const logoData = encodeURIComponent(
  `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1372" height="585" xmlns:v="https://vecta.io/nano"><defs><path d="M368.21 438.809l-.062-219.404c0-40.365-16.509-76.927-43.163-103.399s-63.462-42.88-104.095-42.88-77.444 16.409-104.098 42.881-43.163 63.034-43.163 103.399 16.509 76.928 43.163 103.399 63.462 42.851 104.098 42.851h.062c40.666 0 73.631 32.76 73.631 73.154h-73.693C98.977 438.809 0 340.499 0 219.404S98.977 0 220.889 0s220.886 98.309 220.886 219.404v219.404H368.21z" id="A"/><path d="M661.482 329.735c12.819 0 25.764 2.194 38.837 6.581s24.5 10.442 34.282 18.193l-19.735 27.349c-9.446-7.254-18.722-12.607-27.832-16.087-9.107-3.452-18.468-5.177-28.084-5.177-9.782 0-17.625 1.814-23.529 5.44s-8.855 8.483-8.855 14.537c0 5.411 1.94 9.623 5.819 12.665s10.373 5.206 19.483 6.581l33.396 5.558c17.541 2.867 30.74 8.483 39.595 16.819s13.284 19.363 13.284 33.023c0 17.199-6.79 30.946-20.369 41.213-13.577 10.296-31.667 15.444-54.269 15.444-14.168 0-28.127-2.691-41.874-8.102-13.746-5.382-25.933-12.899-36.558-22.493l20.998-26.325c10.289 8.95 20.2 15.473 29.731 19.598 9.528 4.153 19.606 6.201 30.234 6.201 10.964 0 19.735-2.018 26.311-6.055 6.579-4.066 9.867-9.448 9.867-16.204 0-6.055-2.232-10.793-6.702-14.157-4.47-3.393-11.936-5.909-22.394-7.605l-35.166-6.055c-15.183-2.545-26.694-7.839-34.537-15.941s-11.763-18.544-11.763-31.385c0-16.526 6.281-29.572 18.848-39.195s29.558-14.42 50.98-14.42zm237.321 47.824v76.635c0 8.424 2.489 15.181 7.466 20.241s11.596 7.576 19.86 7.576c5.903 0 11.175-1.111 15.812-3.393a30.65 30.65 0 0 0 11.511-9.74v-91.318h34.663V509.36h-34.663v-10.647c-5.058 4.212-10.71 7.459-16.95 9.74s-12.989 3.422-20.241 3.422c-15.18 0-27.662-4.943-37.445-14.8s-14.677-22.464-14.677-37.82v-81.695h34.663zm402.283-2.545c9.782 0 18.977 1.784 27.577 5.324s16.066 8.395 22.391 14.537 11.301 13.397 14.928 21.762c3.627 8.336 5.441 17.316 5.441 26.939 0 9.594-1.814 18.603-5.441 26.939s-8.601 15.561-14.928 21.616c-6.325 6.084-13.787 10.881-22.391 14.42s-17.795 5.324-27.577 5.324-18.974-1.784-27.577-5.324-16.066-8.336-22.391-14.42c-6.325-6.055-11.301-13.28-14.928-21.616s-5.438-17.345-5.438-26.939c0-9.623 1.811-18.603 5.438-26.939 3.627-8.365 8.604-15.62 14.928-21.762s13.787-10.998 22.391-14.537 17.795-5.324 27.577-5.324zm-490.582-38.961v41.506h37.445v29.075h-37.445v58.441c0 6.23 1.349 10.618 4.049 13.163 2.697 2.515 7.422 3.773 14.168 3.773 3.206 0 6.243-.205 9.11-.614 2.867-.439 5.988-1.228 9.361-2.399v28.314c-3.712 1.199-8.182 2.164-13.41 2.925s-9.698 1.141-13.41 1.141c-14.674 0-25.764-3.334-33.27-10.003s-11.26-16.409-11.26-29.221v-65.52H748.77v-29.074h27.071v-33.667l34.663-7.839zm337.26-11.378V509.36h-34.157v-10.881c-5.228 4.212-11.049 7.371-17.459 9.477s-13.071 3.159-19.986 3.159c-9.276 0-18.006-1.755-26.188-5.324-8.179-3.539-15.306-8.336-21.379-14.42-6.073-6.055-10.836-13.221-14.293-21.499-3.458-8.249-5.187-17.111-5.187-26.559s1.77-18.281 5.312-26.559c3.543-8.249 8.349-15.415 14.422-21.499s13.281-10.852 21.63-14.303 17.248-5.177 26.694-5.177a67.35 67.35 0 0 1 18.848 2.662c6.158 1.755 11.851 4.329 17.078 7.722v-53.908l34.663-7.576zm61.986 52.884V509.36h-34.663v-131.8h34.663zm91.336 27.553c-10.119 0-18.722 3.715-25.808 11.144-7.082 7.4-10.625 16.526-10.625 27.32 0 10.618 3.543 19.656 10.625 27.056 7.085 7.43 15.689 11.144 25.808 11.144s18.722-3.715 25.808-11.144c7.082-7.4 10.625-16.438 10.625-27.056 0-10.793-3.543-19.919-10.625-27.32-7.085-7.43-15.686-11.144-25.808-11.144zm-219.356 0c-10.964 0-20.115 3.685-27.452 10.998-7.337 7.342-11.008 16.409-11.008 27.202 0 10.618 3.712 19.656 11.134 27.086 7.422 7.4 16.528 11.115 27.326 11.115 6.409 0 12.269-1.082 17.581-3.276s9.911-5.324 13.79-9.36v-51.363c-3.712-3.89-8.308-6.903-13.79-9.097s-11.342-3.305-17.581-3.305zm110.564-82.719c5.397 0 10.034 1.93 13.913 5.821s5.822 8.512 5.822 13.923c0 5.382-1.942 10.033-5.822 13.894-3.879 3.89-8.516 5.821-13.913 5.821s-10.037-1.93-13.916-5.821c-3.879-3.861-5.821-8.512-5.821-13.894 0-5.411 1.942-10.033 5.821-13.923s8.516-5.821 13.916-5.821zM1090.038 73.125c9.774 0 18.804 1.258 27.095 3.802 8.288 2.516 15.399 6.055 21.335 10.589s10.558 9.945 13.872 16.234 4.973 13.162 4.973 20.68c0 9.068-2.443 17.316-7.328 24.746-4.885 7.4-11.517 13.279-19.895 17.667 9.946 3.481 17.933 8.892 23.953 16.204 6.02 7.342 9.031 15.707 9.031 25.126 0 7.693-1.831 14.83-5.497 21.47s-8.77 12.314-15.314 17.023-14.311 8.424-23.298 11.115c-8.987 2.72-18.804 4.066-29.45 4.066-14.135 0-27.575-2.545-40.315-7.605s-23.383-12.022-31.936-20.943l24.085-22.23c7.328 7.313 14.571 12.46 21.727 15.444 7.155 2.954 15.882 4.446 26.179 4.446 11.169 0 20.244-2.369 27.224-7.078s10.47-10.823 10.47-18.311c0-6.815-3.183-12.226-9.554-16.234s-14.791-6.025-25.261-6.025h-16.754v-28.519h13.088c9.426 0 17.277-2.545 23.561-7.605s9.423-11.407 9.423-19.1c0-6.786-3.098-12.46-9.294-16.994-6.193-4.563-14.004-6.815-23.426-6.815-8.902 0-16.754 1.609-23.561 4.826-6.807 3.247-14.135 8.775-21.99 16.643l-24.345-22.259c8.902-9.419 19.635-16.848 32.2-22.259s25.565-8.102 39.004-8.102zm-433.236 2.867v183.222h-35.865V112.379l-35.862 14.654V95.911l48.95-19.919h22.777zm132.458 0l74.343 183.222h-41.099l-18.585-48.145h-75.653l-18.848 48.146H669.89l75.39-183.222h43.98zm146.33-2.34c9.774 0 18.804 1.346 27.095 4.066 8.291 2.691 15.358 6.493 21.203 11.378s10.385 10.823 13.612 17.784c3.23 6.991 4.844 14.567 4.844 22.786 0 10.472-2.618 20.153-7.855 29.045s-14.311 19.1-27.224 30.625l-44.764 39.78h82.197v30.098H872.504v-25.126l72.248-64.643c8.203-7.517 14.051-14.099 17.541-19.773 3.49-5.645 5.233-11.554 5.233-17.667 0-8.014-3.139-14.654-9.423-19.89s-14.135-7.839-23.561-7.839c-8.723 0-16.882 1.755-24.474 5.236s-15.838 9.243-24.74 17.257l-20.156-24.073c10.645-9.594 21.902-16.848 33.768-21.733s24.085-7.312 36.649-7.312zm-169.107 39.517l-26.437 67.538h52.352l-25.916-67.538z" id="B"/></defs><g fill-rule="evenodd"><path fill="#38d1c4" d="M0 584.992h441.731v-73.125H0z"/><g fill="#fff"><use xlink:href="#A"/><use xlink:href="#B"/></g></g></svg>`
);

export function GET(request: Request) {
  const { searchParams } = new URL(request.url);

  // ?title=<title>&type=<type>&desc=<desc>
  const title = searchParams.has("title")
    ? searchParams.get("title")
    : "1A23 Studio";
  const type = searchParams.has("type") ? searchParams.get("type") : null;
  const desc = searchParams.has("desc") ? searchParams.get("desc") : null;
  const typeColor = type ? typeColors[type.toLowerCase()] : null;

  return new ImageResponse(
    (
      <div
        style={{
          fontFeatureSettings: "'palt' 1",
        }}
        tw="flex w-full h-full text-white relative bg-[#083d77]"
      >
        <div
          style={{
            backgroundImage: `url(data:image/svg+xml,${patternData})`,
          }}
          tw="flex absolute top-0 right-0 w-3/10 opacity-40 h-[630px] z-[1] bg-repeat bg-size-[100px_100px] bg-center"
        ></div>
        <div
          style={{
            width: Math.round((width - 100) * 0.675),
          }}
          tw="flex flex-col justify-center absolute top-[50px] left-[50px] bottom-[50px] gap-5"
        >
          <img
            src={`data:image/svg+xml,${logoData}`}
            style={{
              height: 75,
              width: Math.round(75 * logoRatio),
            }}
          />
          <div tw="flex flex-1"></div>
          {type && (
            <div tw="flex mb-[-8px]">
              <small
                style={{
                  fontFamily: "Inter",
                  borderColor: typeColor || "#00171f",
                  color: typeColor || "#fff",
                }}
                tw="inline-flex lowercase text-[24px] font-bold italic border-2 px-2 py-1 rounded-lg max-w-full"
              >
                {type}
              </small>
            </div>
          )}
          <div
            style={{
              fontFamily: "'Red Hat Display', 'Source Han Sans'",
              fontFeatureSettings: "'palt' 1",
              maxHeight: 60 * 1.3 * 3,
              lineClamp: 3,
            }}
            tw="block text-[60px] font-extrabold text-white leading-[1.1] overflow-hidden p-0 w-full"
          >
            {title}
          </div>
          {desc && (
            <div
              style={{
                fontFamily: "Inter, 'Source Han Sans'",
                lineClamp: 2,
              }}
              tw="block text-[20px] leading-[1.5] overflow-hidden m-0 p-0 w-full"
            >
              {desc}
            </div>
          )}
        </div>
      </div>
    ),
    {
      width,
      height,
      format: "png",
      fonts,
      module: import("@takumi-rs/wasm/next"),
    }
  );
}
