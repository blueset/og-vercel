import { ImageResponse } from "@takumi-rs/image-response/wasm";
import type { FontDetails } from "@takumi-rs/wasm";
import module from "@takumi-rs/wasm/next";

export const runtime = "edge";

const width = 1200;
const height = 630;
const logoRatio = 1660 / 587;

const fonts = [
  {
    name: "Inter",
    data: await fetch(
      `https://rsms.me/inter/font-files/InterVariable.woff2?v=4.1`
    ).then((r) => r.arrayBuffer()),
  },
  {
    name: "Inter",
    style: "italic",
    data: await fetch(
      `https://rsms.me/inter/font-files/InterVariable-Italic.woff2?v=4.1`
    ).then((r) => r.arrayBuffer()),
  },
  {
    name: "Red Hat Display",
    data: await fetch(
      "https://cdn.jsdelivr.net/npm/@typewe/redhatdisplay@1.0.0/fonts/RedHatDisplay-Variable.woff2"
    ).then((r) => r.arrayBuffer()),
  },
  {
    name: "Source Han Sans",
    data: await fetch(
      "https://fast-mirror.isrc.ac.cn/adobe-fonts/source-han-sans/Variable/WOFF2/OTF/SourceHanSans-VF.otf.woff2"
    ).then((r) => r.arrayBuffer()),
  },
] as FontDetails[];

const patternData = encodeURIComponent(
  `<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" fill="none" stroke="#fd4e00" stroke-linejoin="round" xmlns:v="https://vecta.io/nano"><path d="M114 102h75V89h-75zm12.489 12l.011 37.5c0 6.899 2.803 13.147 7.328 17.673A24.92 24.92 0 0 0 176.5 151.5c0-6.899-2.803-13.147-7.328-17.673A24.92 24.92 0 0 0 151.5 126.5h-.01c-6.904 0-12.5-5.597-12.5-12.5h12.51c20.697 0 37.5 16.803 37.5 37.5S172.197 189 151.5 189 114 172.197 114 151.5V114h12.489zM114 63.511l37.5-.011a24.92 24.92 0 0 0 17.673-7.327A24.92 24.92 0 0 0 176.5 38.5a24.92 24.92 0 0 0-7.328-17.673 24.92 24.92 0 0 0-35.344 0A24.92 24.92 0 0 0 126.5 38.5v.011c0 6.903-5.596 12.5-12.5 12.5V38.5C114 17.802 130.803 1 151.5 1S189 17.802 189 38.5 172.197 76 151.5 76H114V63.511zM1 102h75V89H1zm88-26h13V1H89zm0 113h13v-75H89zM63.511 76L63.5 38.5c0-6.899-2.802-13.147-7.328-17.673S45.399 13.5 38.5 13.5s-13.147 2.803-17.672 7.327S13.5 31.601 13.5 38.5s2.803 13.147 7.328 17.673S31.601 63.5 38.5 63.5h.011c6.904 0 12.5 5.597 12.5 12.5H38.5C17.803 76 1 59.197 1 38.5S17.803 1 38.5 1 76 17.802 76 38.5V76H63.511zM76 126.489l-37.5.011c-6.899 0-13.147 2.803-17.672 7.327a24.92 24.92 0 0 0 0 35.345c4.525 4.524 10.774 7.327 17.672 7.327s13.148-2.803 17.672-7.327A24.92 24.92 0 0 0 63.5 151.5v-.011c0-6.903 5.596-12.5 12.5-12.5V151.5c0 20.697-16.803 37.5-37.5 37.5S1 172.197 1 151.5 17.803 114 38.5 114H76v12.489z" stroke-width="3" /></svg>`
);
const logoData = encodeURIComponent(
  `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1660" height="587" xmlns:v="https://vecta.io/nano"><defs><path d="M369.267 440.309l-.062-220.154c0-40.503-16.556-77.19-43.287-103.752s-63.644-43.027-104.394-43.027-77.667 16.465-104.397 43.027-43.287 63.249-43.287 103.752 16.556 77.191 43.287 103.752 63.644 42.998 104.397 42.998h.062c40.783 0 73.842 32.872 73.842 73.404h-73.904C99.262 440.309 0 341.663 0 220.154S99.262 0 221.524 0s221.521 98.645 221.521 220.154v220.154h-73.777z" id="A"/></defs><g fill="none" fill-rule="evenodd"><path fill="#fd4e00" d="M0 586.992h443v-73.375H0z"/><use fill="#fff" xlink:href="#A"/><g fill-rule="nonzero"><path d="M609.03 288.939v222.553h109.687c46.736 0 77.894-25.753 77.894-64.54 0-21.937-13.671-40.06-34.973-50.233 16.85-10.492 27.342-27.342 27.342-46.736 0-36.244-30.522-61.043-75.35-61.043h-104.6zm101.739 38.152c19.712 0 32.429 10.174 32.429 26.388s-12.717 26.388-32.429 26.388H655.13V327.09h55.638zm4.451 146.249h-60.09v-57.546h60.089c21.302 0 34.973 11.446 34.973 28.614 0 17.804-13.671 28.932-34.973 28.932zm154.197-193.939l-43.557 9.538v222.553h43.557zm26.389 149.429c0 48.326 38.788 85.842 88.385 85.842s88.385-37.516 88.385-85.842-38.788-86.16-88.385-86.16-88.385 37.834-88.385 86.16zm88.385 48.008c-25.753 0-45.782-21.302-45.782-48.008 0-27.342 20.348-48.326 45.782-48.326 25.753 0 45.782 20.984 45.782 48.326 0 26.706-20.03 48.008-45.782 48.008zm192.667 35.608c16.533 0 32.429-5.087 45.464-14.943v13.671c0 21.619-13.353 33.065-39.424 33.065-17.486 0-34.655-4.451-52.777-13.353l-15.261 34.019c19.394 9.856 43.557 14.943 68.991 14.943 53.095 0 82.027-24.481 82.027-68.356V345.849h-42.921v10.81c-13.035-8.584-28.296-13.353-44.829-13.353-47.69 0-85.206 37.198-85.206 84.252 0 47.372 37.198 84.888 83.934 84.888zm-41.013-84.888c0-26.388 20.984-47.054 48.008-47.054 14.943 0 28.932 5.723 38.47 14.943v65.176c-9.856 9.538-23.209 14.943-38.788 14.943-27.024 0-47.69-20.984-47.69-48.008z" fill="#fd4e00"/><path d="M639.427 67.804H626.72L594.043 81.52v17.75l25.415-10.691V209h19.969zM652.538 209h21.986l16.54-41.35H754.2L770.538 209h22.995L735.844 67.804h-24.81L652.538 209zm45.586-58.899l24.608-61.925 24.608 61.925h-49.217zM801.198 209h97.829v-17.145h-70.195l39.737-36.711c21.785-20.373 28.239-31.467 28.239-47.805 0-24.205-19.969-41.35-48.612-41.35-17.952 0-34.694 6.858-50.427 20.978l11.497 13.716c14.12-12.506 24.81-17.347 38.526-17.347 16.944 0 29.449 10.489 29.449 25.214 0 11.296-5.244 19.767-21.583 35.299l-54.461 50.629V209zm215.425-38.93c0-15.532-11.094-27.836-28.239-32.879 14.321-6.656 22.995-18.557 22.995-32.879 0-22.591-20.373-38.728-48.612-38.728-19.566 0-37.518 7.665-51.436 21.583l13.514 12.909c12.506-12.304 22.793-16.944 37.518-16.944 16.54 0 29.046 9.682 29.046 22.591 0 14.12-12.304 24.608-28.844 24.608h-10.691v16.338h12.304c19.364 0 32.072 9.077 32.072 22.39 0 14.523-13.514 24.608-33.282 24.608-16.338 0-27.836-4.639-39.737-16.137l-13.514 12.708c13.514 13.514 32.475 20.776 53.453 20.776 31.063 0 53.453-17.145 53.453-40.947zm53.049 15.531c16.137 16.338 37.921 25.415 60.513 25.415 33.685 0 56.277-17.347 56.277-43.367 0-21.986-13.514-34.29-43.367-39.131l-22.793-3.631c-18.154-3.026-25.214-8.472-25.214-19.969 0-12.506 12.304-20.978 30.66-20.978 15.733 0 30.861 5.648 46.191 17.347l11.699-16.137c-15.935-12.304-36.711-19.162-56.882-19.162-31.467 0-52.041 15.935-52.041 40.543 0 20.373 12.708 32.475 38.526 36.711l23.6 3.832c20.574 3.429 28.643 9.682 28.643 22.188 0 13.918-13.918 23.6-34.29 23.6-17.549 0-33.282-7.262-48.612-22.188l-12.909 14.926zm143.213-2.017c0 17.75 10.691 27.231 30.66 27.231 6.051 0 13.716-1.21 19.162-3.026v-16.944c-5.043 1.815-9.077 2.421-14.725 2.421-10.892 0-15.128-3.832-15.128-14.321v-55.672h30.256V106.33h-30.256V75.267l-19.969 4.841v26.222H1191.1v16.944h21.785v60.311zm84.919-77.254h-20.171v64.345c0 23.802 16.338 40.342 39.938 40.342 12.506 0 22.793-4.236 30.861-12.304V209h20.171V106.33h-20.171v73.624c-5.648 8.673-14.321 13.514-25.214 13.514-15.532 0-25.415-10.085-25.415-26.222V106.33zM1471.072 209h19.969V63.366l-20.171 4.438v46.998c-8.875-6.455-19.566-10.085-30.861-10.085-29.449 0-52.243 23.196-52.243 52.848 0 29.853 22.793 53.049 51.839 53.049 11.901 0 22.793-4.034 31.467-11.296V209zm-63.538-51.637c0-20.171 15.128-35.299 34.896-35.299 11.296 0 21.785 4.438 28.441 12.103v46.595c-6.858 7.867-16.944 12.304-28.441 12.304-19.767 0-34.896-15.532-34.896-35.702zm117.394-67.573c6.858 0 12.506-5.648 12.506-12.506s-5.648-12.506-12.506-12.506-12.304 5.648-12.304 12.506 5.446 12.506 12.304 12.506zm10.085 16.54h-20.171V209h20.171V106.33zm19.163 51.234c0 30.055 23.6 53.453 53.453 53.453s53.251-23.398 53.251-53.453c0-29.853-23.398-53.251-53.251-53.251s-53.453 23.398-53.453 53.251zm53.453 35.702c-18.961 0-33.685-15.733-33.685-35.702s14.926-35.501 33.685-35.501c18.557 0 33.484 15.532 33.484 35.501s-14.926 35.702-33.484 35.702z" fill="#fff"/></g></g></svg>`
);

export function GET(request: Request) {
  const { searchParams } = new URL(request.url);

  // ?title=<title>&desc=<desc>
  const title = searchParams.has("title")
    ? searchParams.get("title")
    : "1A23 Studio";
  const desc = searchParams.has("desc") ? searchParams.get("desc") : null;

  return new ImageResponse(
    (
      <div
        style={{
          fontFeatureSettings: "'palt' 1",
        }}
        tw="flex w-full h-full text-white relative bg-[#00161F]"
      >
        <div
          style={{
            backgroundImage: `url(data:image/svg+xml,${patternData})`,
          }}
          tw="flex absolute top-0 right-0 w-3/10 opacity-40 h-[630px] z-[1] bg-repeat bg-size-[100px_100px] bg-center"
        ></div>
        <div
          style={{
            width: Math.round((width - 100) * 0.675),
          }}
          tw="flex flex-col justify-center absolute top-[50px] left-[50px] bottom-[50px] gap-5"
        >
          <img
            src={`data:image/svg+xml,${logoData}`}
            style={{
              height: 75,
              width: Math.round(75 * logoRatio),
            }}
          />
          <div
            tw="flex flex-1"
          ></div>
          <div
            style={{
              fontFamily: "'Red Hat Display', 'Source Han Sans'",
              fontFeatureSettings: "'palt' 1",
              lineClamp: 3,
            }}
            tw="block text-[60px] font-extrabold text-white leading-[1.1] overflow-hidden p-0 w-full"
          >
            {title}
          </div>
          {desc && (
            <div
              style={{
                fontFamily: "'Inter', 'Source Han Sans'",
                lineClamp: 2,
              }}
              tw="block text-[20px] leading-[1.5] overflow-hidden m-0 p-0 w-full"
            >
              {desc}
            </div>
          )}
        </div>
      </div>
    ),
    {
      width,
      height,
      format: "png",
      fonts,
      module,
    }
  );
}
